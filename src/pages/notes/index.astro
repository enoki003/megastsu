---
import { getCollection } from "astro:content";
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';


const url = new URL(Astro.request.url);
const category = url.searchParams.get("category"); // tech 等
const tag = url.searchParams.get("tag");           // astro 等

const all = await getCollection("notes", ({ data }) => !data.draft);

// クエリでフィルタ（未指定なら全件）
const filtered = all
  .filter((e) => (category ? e.data.category === category : true))
  .filter((e) => (tag ? e.data.tags.includes(tag) : true))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// UI用：タグの全集合
const tagSet = new Set<string>();
for (const e of all) for (const t of e.data.tags) tagSet.add(t);
const tags = Array.from(tagSet).sort();

// UI用：カテゴリ（enumと同じ値を並べるのが安全）
const categories = ["note", "tech", "biz", "idea"];
---


<!DOCTYPE html>
<html lang="ja">
    <head>
        <BaseHead title={`Notes - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
    </head>
    <body>
        <Header />
        <main>
<h1>Notes</h1>
<ul>
  {filtered.map((e) => (
    <li>
      <a href={`/notes/${e.slug}/`}>{e.data.title}</a>
      <small> {e.data.category}</small>
    </li>
  ))}
</ul></file>